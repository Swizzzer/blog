---
title: MT19937
publishDate: 2025-03-12
description: 'æ˜¨å¤©æ‰“TPCTFç¢°åˆ°äº†ï¼Œé¡ºä¾¿è®°å½•ä¸€ä¸‹'
tags: ["Crypto", "RNG", "MT19937"]
category: 'Notes'
draft: false 
---

## Solving TPCTF with gf2bv

[gf2bv](https://github.com/maple3142/gf2bv)å…¶å®æ˜¯mapleä½¬å†™å‡ºæ¥æ±‚è§£GF(2)ä¸Šçº¿æ€§æ–¹ç¨‹ç»„çš„ã€‚æ°å¥½MT19937åœ¨GF(2)ä¸Šå…³äºåˆå§‹çŠ¶æ€ä¹Ÿæ˜¯çº¿æ€§é€’æ¨ï¼Œæ‰€ä»¥æ‹¿æ¥æMTä¹Ÿä¸æ˜¯ä¸è¡Œã€‚

è·Ÿmapleç»™çš„ä¾‹å­å¯¹æ‹äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªæ¿å­ä¸»è¦è¦æ”¹çš„å°±æ˜¯

```python
for o in out:
        zeros.append(rng.getrandbits(bs) ^ int(o))
        # åŸé¢˜æ¯è½®getrandbitsäº†ä¸¤æ¬¡ï¼Œè¿™é‡Œä¹Ÿè¦ä¸€æ ·åœ°åš
        rng.getrandbits(32)
```

è¿™é‡Œï¼Œzeros.append()çš„æ—¶å€™éœ€è¦æ³¨æ„å’Œé¢˜ç›®ä¸­è·å–randbitsçš„æ–¹å¼ä¸€è‡´ã€‚æœ¬é¢˜ä¸­æ˜¯æ¯ä¸¤ä¸ªgetrandbits(32)è·å–ä¸€ä¸ªï¼Œæ‰€ä»¥å¾ªç¯é‡Œä¹Ÿæ˜¯è¿™ä¹ˆå†™çš„ã€‚å…¶ä»–åœ°æ–¹å‡ ä¹ä¸ç”¨åŠ¨ã€‚

```python title="exp.py"
from tqdm import trange
from gf2bv import LinearSystem
from gf2bv.crypto.mt import MT19937
from pwn import *
def mt19937(bs, out):
    lin = LinearSystem([32] * 624)
    mt = lin.gens()
    rng = MT19937(mt)
    zeros = []
    for o in out:
        zeros.append(rng.getrandbits(bs) ^ int(o))
        rng.getrandbits(32)
    zeros.append(mt[0] ^ int(0x80000000))
    sol = lin.solve_one(zeros)
    rng = MT19937(sol)
    pyrand = rng.to_python_random()
    return pyrand
conn = remote('127.0.0.1', 1337)
out = []
nums = 5000
for _ in trange(nums):
    out.append(int(conn.recvline()) >> 24)
    conn.sendline(b'')
print(len(out))

# æ¯è½®å–8bitï¼Œflag[]å¯¹è¿›ä½çš„å½±å“æ¯”æƒ³è±¡ä¸­å¤§ä¸å°‘
RNG = mt19937(8, out)
prev = [RNG.getrandbits(32) for _ in range(nums * 2)]
predict = []
check = []
for i in trange(32):
    predict.append(RNG.getrandbits(32)>>16)
    RNG.getrandbits(32)
    check.append(int(conn.recvline())>>16)
    conn.sendline(b'')

print(predict==check)
```

![å¤§ä½¬å†™çš„å·¥å…·ç¡®å®æ˜¯å¿«](./assets/image-21.png)

æœ¬åœ°ç”Ÿæˆæ•°æ®æµ‹äº†ä¸€ä¸‹ï¼Œæ¯”ä¹‹å‰æ‰‹æ“~~æŠ„çš„~~è„šæœ¬å¿«äº†å¥½å¤šğŸ¥¹...
## Yes, and?

Pythonçš„MT19937ä¸­ï¼Œgetrandbits()æ˜¯æŒ‰ç…§32bitä¸ºå•ä½äº§ç”Ÿçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š

- å¦‚æœgetrandbits(0)ï¼Œä¼šç›´æ¥è¿”å›0ï¼Œä¸ä¼šè°ƒç”¨éšæœºæ•°ç”Ÿæˆ
- å¦‚æœgetrandbits(32k)ï¼Œé‚£ä¹ˆä¼šè¿ç»­äº§ç”Ÿkä¸ª32bitçš„æ•°å¹¶æ‹¼æ¥èµ·æ¥
- å¦‚æœgetrandbits(t)ï¼Œ$0<t<32$ï¼Œé‚£ä¹ˆä¼šå…ˆäº§ç”Ÿä¸€ä¸ª32bitçš„æ•°å­—ï¼Œç„¶åæˆªå–å…¶é«˜tä½ä½œä¸ºæœ¬æ¬¡éšæœºæ•°

åœ¨ç”Ÿæˆéšæœºæ•°å‰ï¼ŒMT19937ä¼šåˆå§‹åŒ–ä¸€ä¸ªstateï¼Œstateç”±624ä¸ª32bitçš„æ•°å­—ç»„æˆã€‚å¾€åæ‰€æœ‰getrandbitsäº§ç”Ÿçš„æ•°å­—ï¼Œéƒ½æ˜¯å…³äºè¿™ä¸ªåˆå§‹stateæ¨¡2ä¸‹çº¿æ€§çš„ã€‚è¿™é‡Œçš„**çº¿æ€§**ï¼Œæ„æ€æ˜¯æŠŠåˆå§‹stateçš„äºŒè¿›åˆ¶å±•å¼€è®°ä½œå‘é‡ $\vec{v}$ ï¼Œé‚£ä¹ˆå¯¹æ­¤åçš„getrandbits()äº§ç”Ÿçš„ä»»æ„ä½ç½®çš„bitï¼Œéƒ½å­˜åœ¨ä¸€ä¸ªå‘é‡ $\vec{t}$ ä½¿å¾— $\vec{t}*\vec{s}=bit$ ã€‚

æ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬åªè¦è·å–è¾“å‡ºä¸­ä»»æ„ä¸åŒä½ç½®çš„19968ä¸ªbitï¼Œå°±èƒ½é€šè¿‡æ„é€ çŸ©é˜µè§£æ–¹ç¨‹çš„æ–¹æ³•æ‹¿åˆ°åˆå§‹çŠ¶æ€(å‡å®šçŸ©é˜µæ»¡ç§©)ï¼š

$$
\vec{s}\cdot T = \vec{b}
$$

è¿™é‡Œçš„ $\vec{b}$ é¢˜ç›®ä¸­å°±èƒ½ç›´æ¥æ‹¿åˆ°ã€‚è‡³äº $T$ ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ $\vec{s}$ ä¸ºåªæœ‰ä¸€ä¸ªåˆ†é‡ä¸º1çš„å‘é‡çš„æ–¹å¼ï¼ŒæŒ‰é»‘ç›’è°ƒç”¨çš„æƒ³æ³•é€è¡Œå–å‡ºï¼Œè·Ÿå¾ˆä¹…ä»¥å‰åšè¿‡çš„ä¸€é“ç ´è§£Xoshiro256**çš„é¢˜ç›®æ˜¯ä¸€æ ·çš„æƒ³æ³•ã€‚

> exp copied from [huangx607087](https://huangx607087.online/2021/07/10/Explore-MT19937/#0x03-%E7%BB%99%E5%87%BA%E4%BB%BB%E6%84%8F19937%E4%B8%AAbit-upd-2025-01-22)

```python
Dall=list(map(int,open('data3.txt','r').readlines()))
from Crypto.Util.number import *
from random import *
from tqdm import *
n=1250
D=Dall[:n]
rng=Random()
def getRows(rng):
    #è¿™ä¸€éƒ¨åˆ†æ ¹æ®é¢˜ç›®å®é™…ç¼–å†™ï¼Œå¿…é¡»å’Œé¢˜ç›®å®é™…æ¯”ç‰¹è·å–é¡ºåºå’Œæ–¹å¼å®Œå…¨ä¸€è‡´ï¼Œä¸”ç¡®ä¿æ¯”ç‰¹æ•°å¤§äº19937ï¼Œå¹¶ä¸”è¯·æ³¨æ„zfillã€‚
    row=[]
    for i in range(n):
        row+=list(map(int, (bin(rng.getrandbits(16))[2:].zfill(16))))
    return row
M=[]
for i in tqdm_notebook(range(19968)):#è¿™ä¸€éƒ¨åˆ†ä¸ºå›ºå®šå¥—è·¯ï¼Œå…·ä½“åŸå› å·²ç»å†™åœ¨æ³¨é‡Šä¸­äº†
    """
    referennce:
    ç³–é†‹å°é¸¡å— 2025/1/21 20:26:51
    è¿™éƒ¨åˆ†ä»£ç ç›¸å½“äºå–äº†ä¸€ç»„çº¿æ€§åŸº

    ç³–é†‹å°é¸¡å— 2025/1/21 20:26:56
    å› ä¸ºmt19937æ˜¯çº¿æ€§çš„
    """
    state = [0]*624
    temp = "0"*i + "1"*1 + "0"*(19968-1-i)
    for j in range(624):
        state[j] = int(temp[32*j:32*j+32],2)
    rng.setstate((3,tuple(state+[624]),None)) #è¿™ä¸ªsetstateä¹Ÿæ˜¯å›ºå®šæ ¼å¼ï¼Œå·²äº2025.1.21æµ‹è¯•
    M.append(getRows(rng))
M=Matrix(GF(2),M)
y=[]
for i in range(n):
    y+=list(map(int, (bin(D[i])[2:].zfill(16))))
y=vector(GF(2),y)
s=M.solve_left(y)
#print(s)
G=[]
for i in range(624):
    C=0
    for j in range(32):
        C<<=1
        C|=int(s[32*i+j])
    G.append(C)
import random
RNG1 = random.Random()
for i in range(624):
    G[i]=int(G[i])
RNG1.setstate((int(3),tuple(G+[int(624)]),None))

print([RNG1.getrandbits(16) for _ in range(75)])
print(D[:75])
```

## Some extra...

### Seed Recovery

æœ‰ç¯‡[åšæ–‡](https://stackered.com/blog/python-random-prediction/#seed-recovery-from-few-outputs)è¯¦ç»†åœ°è®²è§£äº†MT19937çš„å·¥ä½œåŸç†ã€‚æ–‡ä¸­ç‰¹åˆ«æåˆ°ï¼Œå¦‚æœPythonçš„MT19937æ˜¯32bitæ•´æ•°çš„seedï¼Œé‚£ä¹ˆåªéœ€è¦ä¸€è½®624ä¸ªè¾“å‡ºä¸­ç‰¹å®šä½ç½®çš„6ä¸ªå³å¯æ¢å¤seedã€‚å½“ç„¶æ¢å¤å‡ºçš„seedæœ‰ä¸¤ç§å¯èƒ½ï¼Œå®é™…ä½¿ç”¨æ—¶è¿˜å¾—åšä¸€äº›é¢å¤–çš„åˆ¤æ–­ã€‚

#### 2025 ApoorvCTF

```python title="task.py"
from Crypto.Util.number import getPrime, bytes_to_long, long_to_bytes
import random

flag = b"apoorvctf{fake_flag}"

def secret(p):
    prime_bytes = p.to_bytes(64, byteorder='big')  
    keys = [bytes_to_long(prime_bytes[i:i+4]) for i in range(0, 64, 4)] 
    enc_p = []
    for key in keys:
        tp = []
        random.seed(key)
        indexes = [0, 1, 2, 227, 228, 229]
        random_arr = [random.getrandbits(32) for _ in range(624)] 
        for j in indexes:
            tp.append(random_arr[j])
        enc_p.append(tp) 
    return enc_p

def encrypt():
    p = getPrime(512)
    q = getPrime(512)
    n = p * q
    e = 65537
    c = pow(bytes_to_long(flag), e, n)
    trash = secret(p)  
    return n, c, trash  

def decrypt(n,p,c):
    q = n//p
    if p*q != n:
        print("Invalid n")
        return
    phi = (p-1)*(q-1)
    d = pow(65537,-1,phi)
    return long_to_bytes(pow(c,d,n))

n, c, trash = encrypt() 
print("n:", n)
print("c:", c)
print("trash:", trash)
#print("flag:", decrypt(n,p,c)) 
```

è¿™é“é¢˜å®Œå…¨å°±æ˜¯ç…§æ¬ä¸Šé¢é‚£ç¯‡åšæ–‡ï¼Œç›´æ¥æŠ„å°±è¡Œã€‚

```python title="exp.py"
def recover_Kj_from_Ii(Ii, Ii1, Ii2, i):
    # Ii => I[i]
    # Ii1 => I[i-1]
    # Ii2 => I[i-2]
    # Ji => J[i]
    # Ji1 => J[i-1]
    Ji = recover_Ji_from_Ii(Ii, Ii1, i)
    Ji1 = recover_Ji_from_Ii(Ii1, Ii2, i-1)
    return recover_kj_from_Ji(Ji, Ji1, i)
def recover_Ji_from_Ii(Ii, Ii1, i):
    # Ii => I[i]
    # Ii1 => I[i-1]
    ji = (Ii + i) ^ ((Ii1 ^ (Ii1 >> 30)) * 1566083941)
    ji &= 0xffffffff
    # return J[i]
    return ji
def init_genrand(seed):
        MT = [0] * 624
        MT[0] = seed & 0xffffffff
        for i in range(1, 623+1): # loop over each element
            MT[i] = ((0x6c078965 * (MT[i-1] ^ (MT[i-1] >> 30))) + i) & 0xffffffff
        return MT

def recover_kj_from_Ji(ji, ji1, i):
    # ji => J[i]
    # ji1 => J[i-1]
    const = init_genrand(19650218)
    key = ji - (const[i] ^ ((ji1 ^ (ji1 >> 30))*1664525))
    key &= 0xffffffff
    # return K[j] + j
    return key
def unshiftRight(x, shift):
    res = x
    for i in range(32):
        res = x ^ res >> shift
    return res

def unshiftLeft(x, shift, mask):
    res = x
    for i in range(32):
        res = x ^ (res << shift & mask)
    return res

def untemper(v):
    v = unshiftRight(v, 18)
    v = unshiftLeft(v, 15, 0xefc60000)
    v = unshiftLeft(v, 7, 0x9d2c5680)
    v = unshiftRight(v, 11)
    return v
def invertlitep(si, si227):
    # li[i] ^ li[i-227] == (((I[i] & 0x80000000) | (I[i+1] & 0x7FFFFFFF)) >> 1) ^ (0x9908b0df if I[i+1] & 1 else 0)
    X = si ^ si227
    # we know the LliB of I[i+1] because MliB of 0x9908b0df is set, we can see if the XOR has been applied
    mti1 = (X & 0x80000000) >> 31
    if mti1:
        X ^= 0x9908b0df
    # undo shift right
    X <<= 1
    # now recover MliB of state I[i]
    mti = X & 0x80000000
    # recover the rest of state I[i+1]
    mti1 += X & 0x7FFFFFFF
    return mti, mti1


import random
import ast
with open("out.txt") as f:
    n = ast.literal_eval(f.readline())
    c = ast.literal_eval(f.readline())
    trash = ast.literal_eval(f.readline())
    # k = 1
    # K = [i]
    for li in trash:
        S = [untemper(li[i]) for i in range(6)]

        I_227_, I_228 = invertlitep(S[3], S[0])
        I_228_, I_229 = invertlitep(S[4], S[1])
        I_229_, I_230 = invertlitep(S[5], S[2])

        I_228 += I_228_
        I_229 += I_229_

        # two possibilities for I_230
        seed1 = recover_Kj_from_Ii(I_230, I_229, I_228, 230)
        seed2 = recover_Kj_from_Ii(I_230+0x80000000, I_229, I_228, 230)
        # only the MliB differs
        print(seed1, seed2)
from Crypto.Util.number import *
plist = [2233556749,1332779457,3663810718,1146419848,2960081222,3483469796,2128181600,3346153247,61541386,1190096622,362663341,784549194,3375914009,2922819453,2926167818,2960726147]
pp = b""
for x in plist:
    assert len(long_to_bytes(x)) == 4
    pp+=long_to_bytes(x)
isPrime(bytes_to_long(pp))
print(pp)
p = bytes_to_long(pp)
q = n//p
e=65537
d = inverse(e,(p-1)*(q-1))
print(long_to_bytes(pow(c,d,n)))
```

### å¯¹å¼‚æˆ–å°é—­

ä¹‹å‰æ‰“æœ¬éƒ¨çš„405æ¯çš„æ—¶å€™[æè¿‡è¿™ä¸ªäº‹æƒ…](https://blog.swizzer.cc/posts/2024-lilac-405%E6%9D%AF/#yamato)ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªMT19937çš„è¾“å‡ºå¼‚æˆ–åç­‰ä»·äºä¸€ä¸ªMT19937çš„è¾“å‡ºã€‚å¦‚æœæŠŠæ‰€æœ‰MT19937çš„è¾“å‡ºæµçœ‹ä½œä¸€ä¸ªé›†åˆï¼Œæ— éå°±æ˜¯è¯´è¿™ä¸ªé›†åˆçš„å…ƒç´ å¯¹äºŒè¿›åˆ¶å¼‚æˆ–å°é—­è€Œå·²ï¼ŒåŸå› åœ¨é‚£ç¯‡blogé‡Œä¹Ÿç®€è¦é˜æ˜äº†ã€‚å…¶å®åœ¨æœ¬ç¯‡çš„è§‚ç‚¹ä¸‹æ›´å®¹æ˜“ï¼Œå› ä¸ºå¼‚æˆ–å°±æ˜¯GF(2)ä¸Šçš„åŠ æ³•å˜›ï¼Œè€Œçº¿æ€§æ˜ å°„ $f$ æ˜¾ç„¶æ»¡è¶³ $f(x_1)+f(x_2)=f(x_1+x_2)$

åšä¸ªå®éªŒ:

```python
#!/usr/bin/sage
from Crypto.Util.number import *
from random import *
from tqdm import *
D = []
n = 624
stream1 = Random()
stream2 = Random()
for _ in trange(624):
    D.append(stream1.getrandbits(32)^^stream2.getrandbits(32))
rng=Random()
def getRows(rng):
    row=[]
    for i in range(n):
        row+=list(map(int, (bin(rng.getrandbits(32))[2:].zfill(32))))
    return row
M=[]
for i in trange(19968):
    state = [0]*624
    temp = "0"*i + "1"*1 + "0"*(19968-1-i)
    for j in range(624):
        state[j] = int(temp[32*j:32*j+32],2)
    rng.setstate((3,tuple(state+[624]),None))
    M.append(getRows(rng))
M=Matrix(GF(2),M)
y=[]
for i in range(n):
    y+=list(map(int, (bin(D[i])[2:].zfill(32))))
y=vector(GF(2),y)
s=M.solve_left(y)
#print(s)
G=[]
for i in range(624):
    C=0
    for j in range(32):
        C<<=1
        C|=int(s[32*i+j])
    G.append(C)
import random
RNG1 = random.Random()
for i in range(624):
    G[i]=int(G[i])
RNG1.setstate((int(3),tuple(G+[int(624)]),None))

print([RNG1.getrandbits(32) for _ in range(75)])
print(D[:75])
```

![ç¡®å®æ˜¯å¯¹çš„](./assets/image-22.png)

ä¸¤ä¸ªMTè¾“å‡ºæµå³ä½¿å…¶ä¸­ä¸€ä¸ªæœ‰"åç§»"(å…ˆç”Ÿæˆä¸€äº›è¾“å‡ºä¹‹åä¸¤è€…å†å¼€å§‹å¼‚æˆ–)ä¹Ÿæ˜¯åŒæ ·æˆç«‹çš„ï¼Œå¯ä»¥ç†è§£ä¸ºMTç”Ÿæˆä¸€æ¬¡è¾“å‡ºåå†…éƒ¨çŠ¶æ€ç»è¿‡äº†ä¸€æ¬¡çº¿æ€§é€’æ¨ï¼Œç„¶ååœ¨ä¸€ä¸ªæ–°çš„åˆå§‹çŠ¶æ€ä¸‹ä¸¤ä¸ªè¾“å‡ºæµè¿›è¡ŒGF(2)ä¸Šçš„åŠ æ³•è¿ç®—ã€‚

ä¸è¿‡å¾ˆå¥‡æ€ªçš„æ˜¯ï¼Œä¸Šé¢è¿™ä¸ªä¾‹å­ç”¨mapleçš„gf2bvå°±æ²¡åŠæ³•æ±‚è§£å‡ºæ¥ï¼Œå¯èƒ½æ˜¯zerosçš„å†™æ³•éœ€è¦è¿›ä¸€æ­¥ä¿®æ­£ï¼Ÿ
